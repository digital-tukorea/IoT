[{"id":"8172a1cd31381315","type":"mqtt in","z":"e5d3c42a520edfbf","name":"바코드 수신","topic":"smart_fridge/barcode_scanned","qos":"0","datatype":"auto-detect","broker":"f495b800278633f0","nl":false,"rap":true,"rh":0,"inputs":0,"x":200,"y":120,"wires":[["de323501856778e3"]]},{"id":"de323501856778e3","type":"function","z":"e5d3c42a520edfbf","name":"SQL 쿼리 생성","func":"// msg.payload가 문자열이면 JSON 데이터만 추출\nif (typeof msg.payload === \"string\") {\n    try {\n        // JSON 부분만 추출 (정규식 활용)\n        let jsonMatch = msg.payload.match(/\\{.*\\}/s);\n        if (jsonMatch) {\n            msg.payload = JSON.parse(jsonMatch[0]);\n        } else {\n            // JSON 형식이 아니면 그냥 로그만 남기고 패스\n            node.warn(\"⚠️ JSON 데이터 감지 실패, 원본 메시지 그대로 유지: \" + msg.payload);\n            return null;\n        }\n    } catch (e) {\n        // JSON 변환 오류가 발생해도 메시지를 무시하지 않고 계속 진행\n        node.warn(\"⚠️ JSON 변환 오류 발생, 원본 메시지 그대로 유지: \" + msg.payload);\n        return null;\n    }\n}\n\n// JSON 객체에서 바코드 데이터 추출\nif (msg.payload && msg.payload.barcode) {\n    msg.topic = \"UPDATE food_inventory SET quantity = quantity + 1 WHERE barcode = '\" + msg.payload.barcode + \"'\";\n    return msg;\n} else {\n    node.warn(\"⚠️ Invalid payload: \" + JSON.stringify(msg.payload));\n    return null;\n}\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":120,"wires":[["e8c9e42a2aa32746"]]},{"id":"e8c9e42a2aa32746","type":"mysql","z":"e5d3c42a520edfbf","mydb":"951ad4ffb693d193","name":"DB 업데이트","x":570,"y":120,"wires":[["7b8a75915a3ef59c"]]},{"id":"7b8a75915a3ef59c","type":"mqtt out","z":"e5d3c42a520edfbf","name":"업데이트된 데이터 전송","topic":"smart_fridge/inventory_update","qos":"0","retain":"false","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"f495b800278633f0","x":780,"y":120,"wires":[]},{"id":"66922ba650524f1b","type":"inject","z":"e5d3c42a520edfbf","name":"바코드 스캔 실행","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":240,"y":60,"wires":[["5686417b0f64a507"]]},{"id":"5686417b0f64a507","type":"exec","z":"e5d3c42a520edfbf","command":"sudo /home/6team/smart_fridge_project/venv/bin/python3 /home/6team/smart_fridge_project/barcode_scanner.py","addpay":"","append":"","useSpawn":"false","timer":"","winHide":false,"oldrc":false,"name":"바코드 스캔","x":430,"y":60,"wires":[["9ebc6e859712c426"],[],[]]},{"id":"9ebc6e859712c426","type":"mqtt out","z":"e5d3c42a520edfbf","name":"바코드 결과 전송","topic":"smart_fridge/barcode_scanned","qos":"0","retain":"false","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"f495b800278633f0","x":620,"y":60,"wires":[]},{"id":"a56cdee75c56716c","type":"inject","z":"e5d3c42a520edfbf","name":"타이머","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":210,"y":180,"wires":[["6d6b413e5cea9c0e"]]},{"id":"6d6b413e5cea9c0e","type":"function","z":"e5d3c42a520edfbf","name":"Query DB","func":"msg.topic = \"SELECT barcode, name, expiry, quantity FROM food_inventory\";\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":360,"y":180,"wires":[["644b9d405ebc416a"]]},{"id":"644b9d405ebc416a","type":"mysql","z":"e5d3c42a520edfbf","mydb":"951ad4ffb693d193","name":"MariaDB 연결","x":540,"y":180,"wires":[["6b106aad9addfbb2"]]},{"id":"6b106aad9addfbb2","type":"ui_table","z":"e5d3c42a520edfbf","group":"efefab69d4c78d84","name":"보유 품목","order":0,"width":"15","height":"20","columns":[],"outputs":0,"cts":false,"x":720,"y":180,"wires":[]},{"id":"4edf0b57a02b182e","type":"mysql","z":"e5d3c42a520edfbf","mydb":"951ad4ffb693d193","name":"보유 중인 재료 가져오기","x":580,"y":240,"wires":[["4462b64945d4100a","d65206846973b2c9"]]},{"id":"9c09f9a65057111e","type":"inject","z":"e5d3c42a520edfbf","name":"MariaDB","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":220,"y":240,"wires":[["d394b40e1ed51427"]]},{"id":"d394b40e1ed51427","type":"function","z":"e5d3c42a520edfbf","name":"쿼리 입력","func":"msg.topic = \"SELECT name FROM food_inventory WHERE quantity > 0;\";\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":240,"wires":[["4edf0b57a02b182e"]]},{"id":"ec0d9107c1396d02","type":"http request","z":"e5d3c42a520edfbf","name":"API 요청","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://api.spoonacular.com/recipes/findByIngredients?ingredients=apple,eggs,frozen dumplings,beverage,milk,cheese,bread,onion,carrot,potato,bacon,pasta,tomato sauce,butter,chicken breast,sausage,yogurt,quail egg,ham,kimchi,chicken nuggets,salmon,shrimp,squid,pork,beef,tofu,fish cake,chocolate,cream cheese,ice cream,tomato,broccoli,mushroom,ketchup,mayonnaise,mustard,doenjang,gochujang,ssamjang,frozen blueberries,whipping cream,stir-fried anchovies,lettuce,canned tuna,mackerel&apiKey=214312872ffd41379d29194c4139d2be","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":400,"y":300,"wires":[["350d7c568d1bf9bb"]]},{"id":"4462b64945d4100a","type":"function","z":"e5d3c42a520edfbf","name":"재료 리스트 변환","func":"const API_KEY = \"214312872ffd41379d29194c4139d2be\";  // API Key\n\n// 재료 한국어 → 영어 변환 매핑\nconst ingredientMap = {\n    \"사과\": \"apple\",\n\"달걀\": \"eggs\",\n\"냉동만두\": \"frozen dumplings\",\n\"음료수\": \"beverage\",\n\"우유\": \"milk\",\n\"치즈\": \"cheese\",\n\"식빵\": \"bread\",\n\"양파\": \"onion\",\n\"당근\": \"carrot\",\n\"감자\": \"potato\",\n\"베이컨\": \"bacon\",\n\"파스타면\": \"pasta\",\n\"토마토소스\": \"tomato sauce\",\n\"버터\": \"butter\",\n\"닭가슴살\": \"chicken breast\",\n\"소시지\": \"sausage\",\n\"요거트\": \"yogurt\",\n\"메추리알\": \"quail egg\",\n\"스팸\": \"ham\",\n\"김치\": \"kimchi\",\n\"치킨너겟\": \"chicken nuggets\",\n\"연어\": \"salmon\",\n\"새우\": \"shrimp\",\n\"오징어\": \"squid\",\n\"돼지고기\": \"pork\",\n\"소고기\": \"beef\",\n\"두부\": \"tofu\",\n\"어묵\": \"fish cake\",\n\"초콜릿\": \"chocolate\",\n\"크림치즈\": \"cream cheese\",\n\"아이스크림\": \"ice cream\",\n\"토마토\": \"tomato\",\n\"브로콜리\": \"broccoli\",\n\"버섯\": \"mushroom\",\n\"케첩\": \"ketchup\",\n\"마요네즈\": \"mayonnaise\",\n\"머스타드\": \"mustard\",\n\"된장\": \"doenjang\",\n\"고추장\": \"gochujang\",\n\"쌈장\": \"ssamjang\",\n\"냉동블루베리\": \"frozen blueberries\",\n\"생크림\": \"whipping cream\",\n\"멸치볶음\": \"stir-fried anchovies\",\n\"상추\": \"lettuce\",\n\"참치캔\": \"canned tuna\",\n\"고등어\": \"mackerel\"\n};\n\n\n// MariaDB에서 가져온 데이터 확인\nlet data = msg.payload;\n\n// 디버깅용 로그 출력\nconsole.log(\"DB에서 가져온 데이터 구조 확인:\", data);\n\n// 배열이 아니거나 데이터가 없으면 오류 반환\nif (!Array.isArray(data) || data.length === 0) {\n    node.error(\"❌ 현재 사용할 수 있는 재료가 없습니다.\", msg);\n    return null;\n}\n\n// 객체 배열을 문자열 배열로 변환\nlet translatedIngredients = data\n    .map(item => {\n        console.log(\"변환 전:\", item);  // 🔍 item 구조 확인\n        return ingredientMap[item.name] || item.name; // ✅ item.name 사용\n    })\n    .join(\",\");\n\nconsole.log(\"변환된 재료 목록:\", translatedIngredients); // ✅ 변환된 데이터 확인\n\n// API 요청을 위한 URL 설정\nmsg.url = `https://api.spoonacular.com/recipes/findByIngredients?ingredients=${translatedIngredients}&apiKey=${API_KEY}`;\nmsg.method = \"GET\";  // HTTP GET 요청\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":220,"y":300,"wires":[["ec0d9107c1396d02"]]},{"id":"c2c6976395048d89","type":"ui_table","z":"e5d3c42a520edfbf","group":"00b061539cbb090f","name":"냉장고 레시피","order":1,"width":24,"height":12,"columns":[{"field":"title","title":"요리 이름","width":"50px","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"usedIngredients","title":"냉장고에 있는 재료","width":"75px","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}},{"field":"missedIngredients","title":"냉장고에 없는 재료","width":"50px","align":"left","formatter":"plaintext","formatterParams":{"target":"_blank"}}],"outputs":0,"cts":false,"x":830,"y":300,"wires":[]},{"id":"1dd8c6ac5b9fb4c2","type":"http in","z":"e5d3c42a520edfbf","name":"보유 품목 조회","url":"/inventory","method":"get","upload":false,"swaggerDoc":"","x":210,"y":420,"wires":[["489ba96e99813afb"]]},{"id":"489ba96e99813afb","type":"function","z":"e5d3c42a520edfbf","name":"function 1","func":"msg.topic = \"SELECT barcode, name, expiry, quantity FROM food_inventory WHERE quantity > 0\";\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":420,"wires":[["e625449a609e349d"]]},{"id":"e625449a609e349d","type":"mysql","z":"e5d3c42a520edfbf","mydb":"951ad4ffb693d193","name":"MariaDB 연결","x":560,"y":420,"wires":[["2742c218889e56cf"]]},{"id":"2742c218889e56cf","type":"function","z":"e5d3c42a520edfbf","name":"function 2","func":"// MariaDB에서 가져온 데이터가 배열인지 확인\nif (!Array.isArray(msg.payload)) {\n    node.error(\"🚨 데이터가 배열이 아닙니다.\");\n    msg.payload = [];\n}\n\n// JSON 형식으로 변환\nmsg.payload = JSON.stringify(msg.payload);\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":740,"y":420,"wires":[["f030389ea4c469ed"]]},{"id":"f030389ea4c469ed","type":"http response","z":"e5d3c42a520edfbf","name":"","statusCode":"","headers":{},"x":890,"y":420,"wires":[]},{"id":"d65206846973b2c9","type":"debug","z":"e5d3c42a520edfbf","name":"debug 1","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":820,"y":240,"wires":[]},{"id":"6cce2db3feeabdfe","type":"inject","z":"e5d3c42a520edfbf","name":"부족한 재료 확인 (30초마다 실행)","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"30","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":280,"y":660,"wires":[["40b30f9a516de4b4"]]},{"id":"40b30f9a516de4b4","type":"function","z":"e5d3c42a520edfbf","name":"SQL: 부족한 재료 조회","func":"msg.topic = \"SELECT barcode, name, quantity FROM food_inventory WHERE quantity <= 2;\";\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":560,"y":660,"wires":[["c65870a3bfa90551"]]},{"id":"c65870a3bfa90551","type":"mysql","z":"e5d3c42a520edfbf","mydb":"951ad4ffb693d193","name":"MariaDB (부족한 재료 조회)","x":820,"y":660,"wires":[["e977f5a257e792f0"]]},{"id":"e977f5a257e792f0","type":"function","z":"e5d3c42a520edfbf","name":"부족한 재료가 있으면 MQTT 발행","func":"if (msg.payload.length > 0) {\n    msg.topic = \"smart_fridge/low_stock_alert\";\n    msg.payload = JSON.stringify(msg.payload);\n    return msg;\n} else {\n    return null;  // 부족한 재료 없으면 전송 안 함\n}","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":270,"y":720,"wires":[["b0775e2f58a008a4"]]},{"id":"b0775e2f58a008a4","type":"mqtt out","z":"e5d3c42a520edfbf","name":"MQTT: 부족한 재료 알림","topic":"smart_fridge/low_stock_alert","qos":"0","retain":"false","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"f495b800278633f0","x":550,"y":720,"wires":[]},{"id":"6212717eaf98c083","type":"http in","z":"e5d3c42a520edfbf","name":"입출고 업데이트","url":"/update_inventory","method":"post","upload":false,"swaggerDoc":"","x":220,"y":780,"wires":[["c688a5585db66d47"]]},{"id":"c688a5585db66d47","type":"json","z":"e5d3c42a520edfbf","name":"JSON 변환","property":"payload","action":"obj","pretty":false,"x":410,"y":780,"wires":[["9fdf3f2455c64ad8"]]},{"id":"9fdf3f2455c64ad8","type":"function","z":"e5d3c42a520edfbf","name":"입출고 SQL 쿼리 생성","func":"try {\n    let payload = (typeof msg.payload === \"string\") ? JSON.parse(msg.payload) : msg.payload;\n\n    if (!payload.barcode || payload.quantity === undefined) {\n        node.warn(\"🚨 잘못된 요청 데이터! payload: \" + JSON.stringify(payload));\n        return null;\n    }\n\n    let barcode = payload.barcode;\n    let quantity = parseInt(payload.quantity, 10); // 정수 변환\n\n    if (isNaN(quantity)) {\n        node.warn(\"🚨 유효하지 않은 수량 값: \" + payload.quantity);\n        return null;\n    }\n\n    if (quantity > 0) {\n        // ✅ 입고 (수량 추가)\n        msg.topic = `UPDATE food_inventory SET quantity = quantity + ${quantity} WHERE barcode = '${barcode}';`;\n    } else {\n        // ✅ 출고 (차감, 0 이하 방지)\n        quantity = Math.abs(quantity);\n        msg.topic = `UPDATE food_inventory SET quantity = GREATEST(quantity - ${quantity}, 0) WHERE barcode = '${barcode}';`;\n    }\n\n    msg.barcode = barcode;\n    return msg;\n} catch (e) {\n    node.error(\"🚨 JSON 변환 오류 발생: \" + e.message);\n    return null;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":780,"wires":[["4488bee74991ded4"]]},{"id":"4488bee74991ded4","type":"mysql","z":"e5d3c42a520edfbf","mydb":"0ce275075db5db19","name":"DB 업데이트","x":830,"y":780,"wires":[["05ac5dd77b13ed28"]]},{"id":"05ac5dd77b13ed28","type":"function","z":"e5d3c42a520edfbf","name":"업데이트된 재고 조회","func":"msg.topic = `SELECT barcode, name, quantity FROM food_inventory WHERE barcode = '${msg.barcode}';`;\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":240,"y":840,"wires":[["d7dada600d599ca6"]]},{"id":"d7dada600d599ca6","type":"mysql","z":"e5d3c42a520edfbf","mydb":"0ce275075db5db19","name":"재고 정보 가져오기","x":470,"y":840,"wires":[["a41780d724acd7e1","1a2c10e621d1459e"]]},{"id":"a41780d724acd7e1","type":"function","z":"e5d3c42a520edfbf","name":"MQTT 메시지 생성","func":"if (msg.payload.length > 0) {\n    msg.topic = \"smart_fridge/inventory_update\";\n    msg.payload = JSON.stringify(msg.payload[0]);\n    return msg;\n} else {\n    return null;\n}","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":690,"y":840,"wires":[["57a6722936d8f2a6"]]},{"id":"57a6722936d8f2a6","type":"mqtt out","z":"e5d3c42a520edfbf","name":"MQTT: 재고 업데이트 전송","topic":"smart_fridge/inventory_update","qos":"0","retain":"false","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"dda57cdb5d701b51","x":930,"y":840,"wires":[]},{"id":"1a2c10e621d1459e","type":"http response","z":"e5d3c42a520edfbf","name":"입출고 결과 응답","statusCode":"200","headers":{},"x":680,"y":900,"wires":[]},{"id":"350d7c568d1bf9bb","type":"function","z":"e5d3c42a520edfbf","name":"API 응답 데이터 변환","func":"if (!Array.isArray(msg.payload)) {\n    node.error(\"🚨 msg.payload가 배열이 아닙니다. 빈 배열로 초기화합니다.\");\n    msg.payload = [];\n}\n\n// 배열 내 각 레시피 객체를 변환\nmsg.payload = msg.payload.map(recipe => ({\n    id: recipe.id,\n    title: recipe.title,\n    usedIngredients: recipe.usedIngredients.map(ing => ing.name).join(\", \"),  \n    missedIngredients: recipe.missedIngredients.map(ing => ing.name).join(\", \"),\n    instructions: recipe.instructions || \"조리법 정보 없음\" // ✅ 조리법 추가\n}));\n\nreturn msg;\n\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":300,"wires":[["c2c6976395048d89","d65206846973b2c9"]]},{"id":"ad25adb25d9f257e","type":"json","z":"e5d3c42a520edfbf","name":"JSON 변환","property":"payload","action":"obj","pretty":false,"x":230,"y":1120,"wires":[["3798a4955472a83b"]]},{"id":"129170487413433b","type":"mysql","z":"e5d3c42a520edfbf","mydb":"951ad4ffb693d193","name":"보유 중인 재료 가져오기","x":580,"y":1000,"wires":[["3d482efb12d09283"]]},{"id":"8ad8d603e2813daf","type":"inject","z":"e5d3c42a520edfbf","name":"MariaDB","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":220,"y":1000,"wires":[["7dd7b456793694df"]]},{"id":"7dd7b456793694df","type":"function","z":"e5d3c42a520edfbf","name":"쿼리 입력","func":"msg.topic = \"SELECT name FROM food_inventory WHERE quantity > 0;\";\nreturn msg;","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":380,"y":1000,"wires":[["129170487413433b"]]},{"id":"5e5aca69e6edd9f8","type":"http request","z":"e5d3c42a520edfbf","name":"API 요청","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://api.spoonacular.com/recipes/findByIngredients?ingredients=apple,eggs,frozen dumplings,beverage,milk,cheese,bread,onion,carrot,potato,bacon,pasta,tomato sauce,butter,chicken breast,sausage,yogurt,quail egg,ham,kimchi,chicken nuggets&apiKey=214312872ffd41379d29194c4139d2be","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":420,"y":1060,"wires":[["19530f40c51da2b9"]]},{"id":"3d482efb12d09283","type":"function","z":"e5d3c42a520edfbf","name":"재료 리스트 변환","func":"const API_KEY = \"d6c62460b4eb4e439182c0f8bb133703\";  // API Key\n\n// 재료 한국어 → 영어 변환 매핑\nconst ingredientMap = {\n    \"사과\": \"apple\",\n    \"달걀\": \"eggs\",\n    \"냉동만두\": \"frozen dumplings\",\n    \"음료수\": \"beverage\",\n    \"우유\": \"milk\",\n    \"치즈\": \"cheese\",\n    \"식빵\": \"bread\",\n    \"양파\": \"onion\",\n    \"당근\": \"carrot\",\n    \"감자\": \"potato\",\n    \"베이컨\": \"bacon\",\n    \"파스타면\": \"pasta\",\n    \"토마토소스\": \"tomato sauce\",\n    \"버터\": \"butter\",\n    \"닭가슴살\": \"chicken breast\",\n    \"소시지\": \"sausage\",\n    \"요거트\": \"yogurt\",\n    \"메추리알\": \"quail egg\",\n    \"스팸\": \"ham\",\n    \"김치\": \"kimchi\",\n    \"치킨너겟\": \"chicken nuggets\"\n};\n\n\n// MariaDB에서 가져온 데이터 확인\nlet data = msg.payload;\n\n// 디버깅용 로그 출력\nconsole.log(\"DB에서 가져온 데이터 구조 확인:\", data);\n\n// 배열이 아니거나 데이터가 없으면 오류 반환\nif (!Array.isArray(data) || data.length === 0) {\n    node.error(\"❌ 현재 사용할 수 있는 재료가 없습니다.\", msg);\n    return null;\n}\n\n// 객체 배열을 문자열 배열로 변환\nlet translatedIngredients = data\n    .map(item => {\n        console.log(\"변환 전:\", item);  // 🔍 item 구조 확인\n        return ingredientMap[item.name] || item.name; // ✅ item.name 사용\n    })\n    .join(\",\");\n\nconsole.log(\"변환된 재료 목록:\", translatedIngredients); // ✅ 변환된 데이터 확인\n\n// API 요청을 위한 URL 설정\nmsg.url = `https://api.spoonacular.com/recipes/findByIngredients?ingredients=${translatedIngredients}&apiKey=${API_KEY}`;\nmsg.method = \"GET\";  // HTTP GET 요청\n\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":240,"y":1060,"wires":[["5e5aca69e6edd9f8"]]},{"id":"19530f40c51da2b9","type":"function","z":"e5d3c42a520edfbf","name":"API 응답 데이터 변환","func":"if (!Array.isArray(msg.payload)) {\n    node.error(\"🚨 msg.payload가 배열이 아닙니다. 빈 배열로 초기화합니다.\");\n    msg.payload = [];\n}\n\n// 레시피 목록을 드롭다운에 맞게 변환\nlet recipes = msg.payload.map(recipe => ({\n    label: recipe.title,  // ✅ 드롭다운에서 표시될 레시피 이름\n    value: JSON.stringify({  // ✅ 선택 시 해당 레시피의 데이터 전달\n        usedIngredients: Array.isArray(recipe.usedIngredients) \n            ? recipe.usedIngredients.map(ing => ing.name.trim()).join(\", \") \n            : \"사용한 재료 없음\",\n        missedIngredients: Array.isArray(recipe.missedIngredients) \n            ? recipe.missedIngredients.map(ing => ing.name.trim()).join(\", \") \n            : \"부족한 재료 없음\"\n    })\n}));\n\nmsg.options = recipes;  // ✅ 드롭다운 노드에 넘길 데이터\nreturn msg;\n","outputs":1,"timeout":0,"noerr":0,"initialize":"","finalize":"","libs":[],"x":620,"y":1060,"wires":[["ad25adb25d9f257e"]]},{"id":"4735ceec6a759be7","type":"change","z":"e5d3c42a520edfbf","name":"","rules":[{"t":"set","p":"options","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":620,"y":1120,"wires":[["3ce67485c0244d3a","4e6d54114708366c"]]},{"id":"3ce67485c0244d3a","type":"ui_dropdown","z":"e5d3c42a520edfbf","name":"레시피 선택","label":"레시피 선택","tooltip":"추천된 레시피 중 하나를 선택하세요.","place":"레시피를 선택하세요","group":"298b80289dee126f","order":1,"width":0,"height":0,"passthru":true,"multiple":false,"options":[{"label":"","value":"","type":"str"}],"payload":"","topic":"msg.selected_recipe","topicType":"msg","className":"","x":810,"y":1120,"wires":[["cc8b433b595d4f46","4e6d54114708366c"]]},{"id":"3798a4955472a83b","type":"function","z":"e5d3c42a520edfbf","name":"레시피 목록 변환","func":"// 레시피 데이터를 msg.payload에서 가져옴\nlet recipes = msg.payload;\n\nif (Array.isArray(recipes)) {\n    msg.options = recipes.map(recipe => ({\n        label: recipe.title,   // 여기서 title이 label로 들어가야 함\n        value: recipe.title    // value도 title로 설정 (혹은 id로 설정 가능)\n    }));\n} else {\n    msg.options = [];\n}\n\nreturn msg;\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":420,"y":1120,"wires":[["4735ceec6a759be7"]]},{"id":"4e6d54114708366c","type":"debug","z":"e5d3c42a520edfbf","name":"debug 5","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":800,"y":1200,"wires":[]},{"id":"cc8b433b595d4f46","type":"ui_table","z":"e5d3c42a520edfbf","group":"47ff348e4144909d","name":"","order":1,"width":"29","height":"26","columns":[],"outputs":0,"cts":false,"x":970,"y":1120,"wires":[]},{"id":"7b6a14fe21bca2d7","type":"http in","z":"e5d3c42a520edfbf","name":"레시피 조회 요청","url":"/get_recipes","method":"get","upload":false,"swaggerDoc":"","x":220,"y":480,"wires":[["320ec36ead5b5bad"]]},{"id":"320ec36ead5b5bad","type":"function","z":"e5d3c42a520edfbf","name":"사용 가능한 재료 조회","func":"msg.topic = \"SELECT name FROM food_inventory WHERE quantity > 0;\";\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":440,"y":480,"wires":[["7873068322b60fbe"]]},{"id":"7873068322b60fbe","type":"mysql","z":"e5d3c42a520edfbf","mydb":"951ad4ffb693d193","name":"DB 연결","x":640,"y":480,"wires":[["905677e7f293febd"]]},{"id":"905677e7f293febd","type":"function","z":"e5d3c42a520edfbf","name":"재료 변환 (API 요청 준비)","func":"var API_KEY = \"214312872ffd41379d29194c4139d2be\";\nvar inventory = msg.payload.map(item => item.name).join(\",\");\nmsg.url = `https://api.spoonacular.com/recipes/findByIngredients?ingredients=${inventory}&apiKey=${API_KEY}`;\nmsg.method = \"GET\";\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":480,"wires":[["d5bab9106443587a"]]},{"id":"fdde0d1333f77e4b","type":"function","z":"e5d3c42a520edfbf","name":"레시피 데이터 필터링 및 재료 매핑","func":"const ingredientMap = {\n   \"사과\": \"apple\",\n\"달걀\": \"eggs\",\n\"냉동만두\": \"frozen dumplings\",\n\"음료수\": \"beverage\",\n\"우유\": \"milk\",\n\"치즈\": \"cheese\",\n\"식빵\": \"bread\",\n\"양파\": \"onion\",\n\"당근\": \"carrot\",\n\"감자\": \"potato\",\n\"베이컨\": \"bacon\",\n\"파스타면\": \"pasta\",\n\"토마토소스\": \"tomato sauce\",\n\"버터\": \"butter\",\n\"닭가슴살\": \"chicken breast\",\n\"소시지\": \"sausage\",\n\"요거트\": \"yogurt\",\n\"메추리알\": \"quail egg\",\n\"스팸\": \"ham\",\n\"김치\": \"kimchi\",\n\"치킨너겟\": \"chicken nuggets\",\n\"연어\": \"salmon\",\n\"새우\": \"shrimp\",\n\"오징어\": \"squid\",\n\"돼지고기\": \"pork\",\n\"소고기\": \"beef\",\n\"두부\": \"tofu\",\n\"어묵\": \"fish cake\",\n\"초콜릿\": \"chocolate\",\n\"크림치즈\": \"cream cheese\",\n\"아이스크림\": \"ice cream\",\n\"토마토\": \"tomato\",\n\"브로콜리\": \"broccoli\",\n\"버섯\": \"mushroom\",\n\"케첩\": \"ketchup\",\n\"마요네즈\": \"mayonnaise\",\n\"머스타드\": \"mustard\",\n\"된장\": \"doenjang\",\n\"고추장\": \"gochujang\",\n\"쌈장\": \"ssamjang\",\n\"냉동블루베리\": \"frozen blueberries\",\n\"생크림\": \"whipping cream\",\n\"멸치볶음\": \"stir-fried anchovies\",\n\"상추\": \"lettuce\",\n\"참치캔\": \"canned tuna\",\n\"고등어\": \"mackerel\"\n};\n\nmsg.payload = msg.payload.map(recipe => {\n    return {\n        \"title\": recipe.title,\n        \"usedIngredients\": recipe.usedIngredients.map(ing => ingredientMap[ing.name] || ing.name).join(\", \"),\n        \"missedIngredients\": recipe.missedIngredients.map(ing => ingredientMap[ing.name] || ing.name).join(\", \")\n    };\n});\n\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":510,"y":540,"wires":[["d9dfa81870672753"]]},{"id":"d5bab9106443587a","type":"http request","z":"e5d3c42a520edfbf","name":"Spoonacular API 호출","method":"GET","ret":"obj","paytoqs":"ignore","url":"https://api.spoonacular.com/recipes/findByIngredients?ingredients=apple,eggs,frozen dumplings,beverage,milk,cheese,bread,onion,carrot,potato,bacon,pasta,tomato sauce,butter,chicken breast,sausage,yogurt,quail egg,ham,kimchi,chicken nuggets,salmon,shrimp,squid,pork,beef,tofu,fish cake,chocolate,cream cheese,ice cream,tomato,broccoli,mushroom,ketchup,mayonnaise,mustard,doenjang,gochujang,ssamjang,frozen blueberries,whipping cream,stir-fried anchovies,lettuce,canned tuna,mackerel&apiKey=214312872ffd41379d29194c4139d2be","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":240,"y":540,"wires":[["fdde0d1333f77e4b"]]},{"id":"8210b91008cf9c40","type":"http in","z":"e5d3c42a520edfbf","name":"레시피 조리법 요청","url":"/getRecipeInstructions","method":"get","upload":false,"swaggerDoc":"","x":230,"y":600,"wires":[["5c688b54b3016a98"]]},{"id":"5c688b54b3016a98","type":"function","z":"e5d3c42a520edfbf","name":"API URL 생성","func":"var recipeId = msg.payload.recipeId;\nvar apiKey = \"214312872ffd41379d29194c4139d2be\";\nvar url = `https://api.spoonacular.com/recipes/${recipeId}/analyzedInstructions?apiKey=${apiKey}`;\nmsg.url = url;\nreturn msg;","outputs":1,"x":430,"y":600,"wires":[["67b8c69276e42ef3"]]},{"id":"67b8c69276e42ef3","type":"http request","z":"e5d3c42a520edfbf","name":"Spoonacular API 호출","method":"GET","ret":"obj","paytoqs":"ignore","url":"","tls":"","persist":false,"proxy":"","insecureHTTPParser":false,"authType":"","senderr":false,"headers":[],"x":640,"y":600,"wires":[["3958eec02824325e"]]},{"id":"3958eec02824325e","type":"function","z":"e5d3c42a520edfbf","name":"조리법 추출","func":"var instructions = [];\nif (msg.payload.length > 0 && msg.payload[0].steps) {\n    msg.payload[0].steps.forEach(step => {\n        instructions.push(`${step.number}. ${step.step}`);\n    });\n}\nmsg.payload = { instructions: instructions };\nreturn msg;","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":850,"y":600,"wires":[["ff72d8aeb0f1502e"]]},{"id":"ff72d8aeb0f1502e","type":"http response","z":"e5d3c42a520edfbf","name":"조리법 응답 전송","statusCode":"200","headers":{},"x":1040,"y":600,"wires":[]},{"id":"d9dfa81870672753","type":"http response","z":"e5d3c42a520edfbf","name":"HTTP 응답 (레시피 데이터 반환)","statusCode":"200","headers":{},"x":810,"y":540,"wires":[]},{"id":"f495b800278633f0","type":"mqtt-broker","name":"","broker":"localhost","port":1883,"clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"5","keepalive":60,"cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"951ad4ffb693d193","type":"MySQLdatabase","name":"","host":"localhost","port":"3306","db":"smart_fridge","tz":"","charset":"UTF8"},{"id":"efefab69d4c78d84","type":"ui_group","name":"냉장고","tab":"f8b0a2bfa39ad195","order":1,"disp":true,"width":"15","collapse":false,"className":""},{"id":"00b061539cbb090f","type":"ui_group","name":"food","tab":"e153cafbb86014ea","order":1,"disp":true,"width":"27","collapse":false,"className":""},{"id":"0ce275075db5db19","type":"MySQLdatabase","name":"","host":"localhost","port":"3306","db":"smart_fridge","tz":"","charset":"UTF8"},{"id":"dda57cdb5d701b51","type":"mqtt-broker","name":"","broker":"localhost","port":1883,"clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"5","keepalive":60,"cleansession":true,"autoUnsubscribe":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"userProps":"","sessionExpiry":""},{"id":"298b80289dee126f","type":"ui_group","name":"Default","tab":"960301b41003c880","order":1,"disp":true,"width":"13","collapse":false,"className":""},{"id":"47ff348e4144909d","type":"ui_group","name":"냉장고","tab":"f78034d6b60b791a","order":1,"disp":true,"width":"42","collapse":false,"className":""},{"id":"f8b0a2bfa39ad195","type":"ui_tab","name":"Home","icon":"dashboard","disabled":false,"hidden":false},{"id":"e153cafbb86014ea","type":"ui_tab","name":"food","icon":"dashboard","disabled":false,"hidden":false},{"id":"960301b41003c880","type":"ui_tab","name":"test","icon":"dashboard","disabled":false,"hidden":false},{"id":"f78034d6b60b791a","type":"ui_tab","name":"Tab 1","icon":"dashboard","order":1,"disabled":false,"hidden":false}]